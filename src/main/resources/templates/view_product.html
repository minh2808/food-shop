<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::layout(~{::section})}">
<head>
<meta charset="ISO-8859-1">
<title>Product Details</title>
<style>
.comment-section {
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}
.comment-item {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.comment-author {
    font-weight: bold;
    color: #007bff;
}
.comment-date {
    font-size: 0.85rem;
    color: #6c757d;
}
.comment-content {
    line-height: 1.6;
}
.comment-form {
    background: white;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 20px;
}
</style>
</head>
<body>
	<section>
		<div class="container card-sh" style="margin-top: 70px;margin-bottom: 100px">

			<div class="col-md-12 p-4">
				<p class="fs-3 text-center">Products Details</p> <br>
				
				<!-- Messages -->
				<th:block th:if="${session.succMsg}">
					<p class="text-success alert alert-success text-center" role="alert">[[${session.succMsg}]]</p>
					<th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
				</th:block>

				<th:block th:if="${session.errorMsg}">
					<p class="text-danger text-center alert alert-danger">[[${session.errorMsg}]]</p>
					<th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
				</th:block>
				
				<!-- Product Details -->
				<div class="row">
					<div class="col-md-6 text-end">
						<img alt="" th:src="@{'/img/product/'+${product.image}}" 
						     style="border-radius: 4px; box-shadow: 0 0 10px rgba(0, 0, 0, .1);"  
						     width="390px" height="400px">
					</div>

					<div class="col-md-6">
						<p class="fs-3">[[${product.title}]]</p>
						<p>
							<span class="fw-bold">Description : </span><br>[[${product.description}]]
						</p>
						<p>
							<span class="fw-bold">Category: [[${product.category}]]</span>
						</p>
						<p class="fs-5 fw-bold">
							Price: <i class="fas fa-rupee-sign"></i> [[${product.discountPrice}]] 
							<span class="fs-6 text-decoration-line-through text-secondary">[[${product.price}]]</span>
							<span class="fs-6 text-success">[[${product.discount}]]% off</span>
						</p>

						<th:block th:if="${user==null}">						
							<a href="/signin" class="btn btn-danger col-md-6">Add To Cart</a>
						</th:block>
						
						<th:block th:unless="${user==null}">						
							<a th:href="@{'/user/addCart?pid='+${product.id}+'&uid='+${user.id}}" 
							   class="btn btn-danger col-md-6">Add To Cart</a>
						</th:block>
					</div>
				</div>

				<!-- Comment Section -->
				<div class="comment-section">
					<h4 class="mb-4">Comments (<span th:text="${totalComments}">0</span>)</h4>
					
					<!-- Comment Form -->
					<th:block th:if="${user != null}">
						<div class="comment-form">
							<form th:action="@{/user/addComment}" method="post">
								<input type="hidden" name="productId" th:value="${product.id}">
								<div class="mb-3">
									<textarea class="form-control" name="content" rows="3" 
									          placeholder="Write your comment..." required></textarea>
								</div>
								<button type="submit" class="btn btn-primary">Post Comment</button>
							</form>
						</div>
					</th:block>
					
					<th:block th:if="${user == null}">
						<div class="alert alert-info">
							<a href="/signin">Login</a> to post a comment
						</div>
					</th:block>
					
					<!-- Comments List -->
					<div class="comments-list">
						<th:block th:if="${#lists.isEmpty(comments)}">
							<p class="text-center text-muted">No comments yet. Be the first to comment!</p>
						</th:block>
						
						<th:block th:each="comment : ${comments}">
							<div class="comment-item">
								<div class="comment-header">
									<div>
										<span class="comment-author" th:text="${comment.user.name}">User</span>
										<span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'dd MMM yyyy HH:mm')}">Date</span>
									</div>
									<th:block th:if="${user != null && user.id == comment.user.id}">
										<form th:action="@{'/user/deleteComment/' + ${comment.id}}" method="post" 
										      style="display: inline;"
										      onsubmit="return confirm('Are you sure you want to delete this comment?');">
											<input type="hidden" name="productId" th:value="${product.id}">
											<button type="submit" class="btn btn-sm btn-outline-danger">
												<i class="fas fa-trash"></i>
											</button>
										</form>
									</th:block>
								</div>
								<div class="comment-content" th:text="${comment.content}">Comment text</div>
							</div>
						</th:block>
					</div>
					
					<!-- Pagination -->
					<th:block th:if="${totalPages > 1}">
						<nav aria-label="Comment pagination">
							<ul class="pagination justify-content-center mt-4">
								<li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
									<a class="page-link" th:href="@{/viewProduct/{id}(id=${product.id}, pageNo=${currentPage - 1})}">Previous</a>
								</li>
								
								<th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
									<li class="page-item" th:classappend="${currentPage == i} ? 'active'">
										<a class="page-link" th:href="@{/viewProduct/{id}(id=${product.id}, pageNo=${i})}" th:text="${i + 1}">1</a>
									</li>
								</th:block>
								
								<li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
									<a class="page-link" th:href="@{/viewProduct/{id}(id=${product.id}, pageNo=${currentPage + 1})}">Next</a>
								</li>
							</ul>
						</nav>
					</th:block>
				</div>
			</div>
		</div>
	</section>
</body>
</html>